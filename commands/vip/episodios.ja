// commands/vip/episodios.js
module.exports = {
    name: 'episodios',
    description: 'Mostra os episÃ³dios de uma temporada especÃ­fica (exclusivo VIP)',
    usage: 'episodios <nÃºmero da sÃ©rie> <nÃºmero da temporada>',
    execute: async ({ message, args, config, client, vpsHandler, userNumber }) => {
        // Verifica se foram fornecidos os argumentos
        if (args.length < 2) {
            return await message.reply(`âŒ *Uso incorreto!*\n\nğŸ“– *Como usar:* ${config.Prefixo}episodios <sÃ©rie> <temporada>\n\nğŸ’¡ *Exemplo:* ${config.Prefixo}episodios 1 1\n\nğŸ“º *Passos:*\n1. ${config.Prefixo}seriesd - ver sÃ©ries\n2. ${config.Prefixo}temp <nÃºmero> - ver temporadas\n3. ${config.Prefixo}episodios <sÃ©rie> <temporada> - ver episÃ³dios`);
        }

        const serieIndex = parseInt(args[0]) - 1;
        const temporadaIndex = parseInt(args[1]) - 1;

        if (isNaN(serieIndex) || isNaN(temporadaIndex) || serieIndex < 0 || temporadaIndex < 0) {
            return await message.reply('âŒ NÃºmeros invÃ¡lidos! Use apenas nÃºmeros positivos.');
        }

        try {
            // Reage com ğŸ“º
            await message.react('ğŸ“º');
            
            // Verifica se a VPS estÃ¡ conectada
            if (!vpsHandler || !vpsHandler.getVPSStatus().connected) {
                return await message.reply('âŒ VPS nÃ£o estÃ¡ conectada! Entre em contato com o dono.');
            }

            // Verifica se o usuÃ¡rio tem lista de sÃ©ries salva
            const userSeriesList = vpsHandler.seriesLists.get(userNumber);
            if (!userSeriesList) {
                return await message.reply(`âŒ VocÃª precisa usar ${config.Prefixo}seriesd primeiro para carregar a lista de sÃ©ries!`);
            }

            // Verifica se o Ã­ndice da sÃ©rie Ã© vÃ¡lido
            if (serieIndex >= userSeriesList.series.length) {
                return await message.reply(`âŒ SÃ©rie nÃ£o encontrada! Use um nÃºmero entre 1 e ${userSeriesList.series.length}.`);
            }

            const serieName = userSeriesList.series[serieIndex];

            // Primeiro busca as temporadas para validar o Ã­ndice da temporada
            const temporadasResult = await vpsHandler.getTemporadas(serieName, userNumber);
            if (!temporadasResult.success || temporadaIndex >= temporadasResult.temporadas.length) {
                return await message.reply(`âŒ Temporada nÃ£o encontrada! Use ${config.Prefixo}temp ${serieIndex + 1} para ver as temporadas disponÃ­veis.`);
            }

            const temporadaName = temporadasResult.temporadas[temporadaIndex];

            // Mensagem de loading
            const loadingMsg = await message.reply(`ğŸ“º Buscando episÃ³dios de "${serieName} - ${temporadaName}"...`);

            // Busca os episÃ³dios
            const resultado = await vpsHandler.getEpisodios(serieName, temporadaName, userNumber);

            if (!resultado.success) {
                await loadingMsg.edit(`âŒ Erro ao acessar episÃ³dios: ${resultado.error}`);
                return;
            }

            const { episodios, total } = resultado;

            if (total === 0) {
                await loadingMsg.edit(`ğŸ“º Nenhum episÃ³dio encontrado em "${serieName} - ${temporadaName}"!`);
                return;
            }

            // Formata a lista de episÃ³dios (limita para evitar mensagem muito grande)
            let episodiosLista = `ğŸ“º *EPISÃ“DIOS* ğŸ“º\n\nğŸ¬ *SÃ©rie:* ${serieName}\nğŸ“ *Temporada:* ${temporadaName}\nğŸ“Š *Total:* ${total} episÃ³dios\nğŸ–¥ï¸ *Fonte:* VPS Cinema\n\n`;
            
            const maxEpisodios = Math.min(episodios.length, 40); // MÃ¡ximo 40 episÃ³dios por mensagem
            
            for (let i = 0; i < maxEpisodios; i++) {
                const episodio = episodios[i];
                episodiosLista += `ğŸ­ ${i + 1}. ${episodio}\n`;
            }

            if (episodios.length > 40) {
                episodiosLista += `\n... e mais ${episodios.length - 40} episÃ³dios!`;
            }

            episodiosLista += `\n\nğŸ’¡ *NavegaÃ§Ã£o:*\nâ€¢ ${config.Prefixo}seriesd - Voltar Ã s sÃ©ries\nâ€¢ ${config.Prefixo}temp ${serieIndex + 1} - Voltar Ã s temporadas\n\nâ­ *Comando exclusivo VIP*\nğŸ¤– *Bot:* ${config.NomeDoBot}\nâ° *Consultado:* ${new Date().toLocaleString('pt-BR')}`;

            await loadingMsg.edit(episodiosLista);
            
            console.log(`ğŸ“º EpisÃ³dios de "${serieName} - ${temporadaName}" acessados por usuÃ¡rio ${userNumber} - ${total} episÃ³dios encontrados`);

        } catch (error) {
            console.error('âŒ Erro no comando episodios:', error);
            await message.reply('âŒ Erro interno ao acessar episÃ³dios. Tente novamente mais tarde.');
        }
    }
};
